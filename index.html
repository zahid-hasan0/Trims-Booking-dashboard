<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trims Booking Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
       <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        /* Main Theme & Layout */
        :root {
            --bg-primary: #0f1720;
            --bg-secondary: #080124;
            --main-bg: #000000;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --accent-blue: #282cf1;
            --accent-red: #e91919;
            --accent-red-hover: #e53e3e;
            --accent-green: #09a011;
            --border-color: #4a5568;
            --card-bg: #051124;;
            --input-bg: #e8ebf031;
            --table-header: #4a5568;
            --header-bg: #1a202c;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--main-bg);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        
        /* --- Login and Register Pages --- */
        .auth-container {
            display: none;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 100vh;
            background-color: var(--main-bg);
        }
        .login-form, .register-form {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }
        .login-form h2, .register-form h2 {
            font-size: 2.2rem;
            color: var(--text-primary);
            margin-bottom: 25px;
            font-weight: 700;
        }
        .auth-container .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .auth-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .auth-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }
        .auth-container input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .auth-container .submit-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .auth-container .submit-btn:hover {
            background-color: #3182ce;
        }
        .auth-container p {
            margin-top: 25px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        .auth-container a {
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 600;
        }
        .auth-container a:hover {
            text-decoration: underline;
        }

        /* --- Dashboard Layout --- */
        #dashboard-container {
            display: none;
            flex-direction: column;
            width: 100%;
            min-height: 100vh;
        }
        .header {
            background-color:  #061d33;
            padding: 20px 40px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 20px 4px 10px rgba(0,0,0,0.2);
            position: relative;
        }
        .header-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }
        .profile-dropdown {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .profile-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--bg-secondary);
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            z-index: 1;
            border-radius: 8px;
            padding: 10px 0;
            margin-top: 1px;
        }
        .profile-dropdown:hover .profile-dropdown-content {
            display: block;
        }
        .profile-dropdown-content a {
            color: var(--text-secondary);
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            font-weight: 500;
        }
        .profile-dropdown-content a:hover {
            background-color: #3a475d;
            color: var(--text-primary);
        }
        .profile-dropdown-content .logout-btn {
            color: var(--accent-red);
            font-weight: 600;
        }
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-blue);
            margin-left: 15px;
        }
        .main-container {
            display: flex;
            flex: 1;
        }
        .sidebar {
            width: 320px;
            background-color: #051124;;
            padding: 30px;
            box-shadow: 2px 10 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-menu-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sidebar-menu-btn:hover {
            background-color: #5a6473;
        }

        .form-section-title {
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .sidebar .form-group {
            margin-bottom: 15px;
        }
        .sidebar input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px 50px;
            background-color: var(--main-bg);
            overflow-y: auto;
        }
        
        .main-content-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }
        .search-container {
            flex-grow: 1;
        }
        .search-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }
        .date-filter-group {
            margin-top: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .date-filter-group label {
            color: var(--text-secondary);
        }
        .date-filter-group input {
            width: 150px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--text-primary);
        }
        .clear-btn {
            padding: 10px 20px;
            background-color: #c00505;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .clear-btn:hover {
            background-color: #810108;
        }

        .list-header {
            margin-top: 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        .list-header h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        /* Table Styles */
        .table-container {
             background-color: linear-gradient(180deg, #031620, #030e18);
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            background-color: var(--card-bg);
                box-shadow: 0 6px 30px rgba(0, 0, 0, 0.6);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 18px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        td{
              border: 1px solid rgba(0, 0, 0, 0.1);
        }
        th {
            background-color: linear-gradient(180deg, #071722, #071018);
            color:#9fd8d1;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow:
                       0 0 2px rgba(159, 216, 209, 0.6),
                        0 0 5px rgba(159, 216, 209, 0.4);
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: #384252;
        }
        .action-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            margin-right: 15px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }
        .action-buttons .edit-btn { color: #ffc107; }
        .action-buttons .delete-btn { color: var(--accent-red); }

        /* --- Modals and Notifications --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            padding-top: 60px;
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
            color: var(--text-primary);
        }
        .modal-content h3 {
            margin-top: 0;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.8rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        .modal-buttons {
            text-align: right;
            margin-top: 25px;
        }
        .modal-buttons button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            margin-left: 10px;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        .modal-buttons button:hover {
            transform: translateY(-2px);
        }
        .modal-buttons .confirm-btn { background-color: var(--accent-red); color: rgb(10, 2, 80); }
        .modal-buttons .cancel-btn { background-color: #c70404; color: white; }
        .modal-buttons .save-btn { background-color: var(--accent-green); color: white; }
        .close {
            color: var(--text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover, .close:focus {
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
        }
        #notification-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            pointer-events: none;
        }
        .notification {
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 500;
            color: white;
            text-align: center;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .notification.success {
            background-color: var(--accent-green);
        }
        .notification.error {
            background-color: var(--accent-red);
        }
        .notification.info {
            background-color: var(--accent-blue);
        }
        /* add data button design */
        .submit-btn{
                background: linear-gradient(135deg, #0f2c8a, #35066e);
                border: none;
                color: white;
                padding: 12px 24px;
                font-size: 16px;
                font-weight: bold;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                }

                .submit-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
                }
                .excel_up {
                border: 2px dotted white;
                padding: 10px 20px;
                background-color: transparent;
                color: white;
                border-radius: 6px; /* optional */
                cursor: pointer;   /* for button-like behavior */
                }


                /* edit modal css  */
   #edit-form label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #fcfcfc;
    font-size: 15px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#edit-form input[type="text"],
#edit-form input[type="email"],
#edit-form input[type="password"] {
    width:100%;
    padding: 4px 5px;
    margin-bottom: 4px;
    border: 1px solid #c0c0c0;
    border-radius: 8px;
    font-size: 16px;
    box-sizing: border-box;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

#edit-form input[type="text"]:focus,
#edit-form input[type="email"]:focus,
#edit-form input[type="password"]:focus {
    border-color: #9fd8d1;
    outline: none;
    box-shadow: 0 0 8px rgba(159, 216, 209, 0.6);
}        



    </style>
</head>
<body>

<div id="notification-container"></div>

<div id="auth-container" class="auth-container">
    <div id="login-form" class="login-form">
        <h2>Trims Booking</h2>
        <p style="margin-bottom: 30px; font-weight: 600; color: #a0aec0;">User Login</p>
        <div class="form-group">
            <label for="login-email">Email</label>
            <input type="email" id="login-email" required>
        </div>
        <div class="form-group">
            <label for="login-password">Password</label>
            <input type="password" id="login-password" required>
        </div>
        <button id="login-btn" class="submit-btn">Login</button>
        <p>Don't have an account? <a href="#" id="show-register">Sign Up here</a></p>
    </div>

    <div id="register-form" class="login-form" style="display:none;">
        <h2>Trims Booking</h2>
        <p style="margin-bottom: 30px; font-weight: 600; color: #a0aec0;">User Registration</p>
        <div class="form-group">
            <label for="register-name">Full Name</label>
            <input type="text" id="register-name" required>
        </div>
        <div class="form-group">
            <label for="register-email">Email</label>
            <input type="email" id="register-email" required>
        </div>
        <div class="form-group">
            <label for="register-password">Password</label>
            <input type="password" id="register-password" required>
        </div>
        <button id="register-btn" class="submit-btn">Register</button>
        <p>Already have an account? <a href="#" id="show-login">Log In here</a></p>
    </div>
</div>

<div id="dashboard-container">
    <header class="header">
        <h1 class="header-title">Trims Booking Dashboard</h1>
        <div class="profile-dropdown">
            <span id="user-name-display-header"></span>
            <img id="profile-avatar-header" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 448 512' fill='%23e2e8f0'><path d='M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z'/></svg>" alt="Profile Picture" class="profile-pic">
            <div class="profile-dropdown-content">
                <a href="#" id="edit-profile-btn">Edit Profile</a>
                <a href="#" id="logout-btn" class="logout-btn">Logout</a>
            </div>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
           

            <h3 class="form-section-title">Add / Edit Booking</h3>
            <form id="booking-form">
                <div class="form-group">
                    <label for="date">Date</label>
                    <input type="date" id="date" required>
                </div>
                <div class="form-group">
                    <label for="bookingNo">Booking No.</label>
                    <input type="text" id="bookingNo" required>
                </div>
                <div class="form-group">
                    <label for="customer">Customer</label>
                    <input type="text" id="customer" required>
                </div>
                <div class="form-group">
                    <label for="buyer">Buyer</label>
                    <input type="text" id="buyer" required>
                </div>
                <div class="form-group">
                    <label for="item">Item</label>
                    <input type="text" id="item" required>
                </div>
                <button type="submit" class="submit-btn" style="margin-top: 15px;">Add Booking</button>
            </form>

            <!-- upload excel and downlad format  -->
             <div class="excel_up">
             <button id="upload-excel-btn" class="sidebar-menu-btn">Upload Excel/CSV</button>
            <input type="file" id="excel-file-input" accept=".xlsx, .xls, .csv" style="display: none;">
            <br>
            <button style="margin-top: 10px;" id="download-template-btn" class="sidebar-menu-btn">Download Template</button> </div>

        </aside>

        <main class="main-content">
            <div class="main-content-header">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search by Booking No, Customer, Buyer, Item or Date...">
                    <div class="date-filter-group">
                        <label for="from-date">from</label>
                        <input type="date" id="from-date">
                        <label for="to-date">to</label>
                        <input type="date" id="to-date">
                        <button id="clear-filters-btn" class="clear-btn">Clear</button>
                    </div>
                </div>
            </div>
            
            <div class="list-header">
                <h2>Bookings List</h2>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Booking No.</th>
                            <th>Customer</th>
                            <th>Buyer</th>
                            <th>Item</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="bookings-table-body">
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('edit-modal')">&times;</span>
        <h3>Edit Booking</h3>
        <form id="edit-form">
            <input  type="hidden" id="edit-booking-id">
            <div class="form-group">
                <label for="edit-date">Date</label>
                <input type="date" id="edit-date" required>
            </div>
            <div class="form-group">
                <label for="edit-bookingNo">Booking No.</label>
                <input type="text" id="edit-bookingNo" required>
            </div>
            <div class="form-group">
                <label for="edit-customer">Customer</label>
                <input type="text" id="edit-customer" required>
            </div>
            <div class="form-group">
                <label for="edit-buyer">Buyer</label>
                <input type="text" id="edit-buyer" required>
            </div>
            <div class="form-group">
                <label for="edit-item">Item</label>
                <input type="text" id="edit-item" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" onclick="closeModal('edit-modal')">Cancel</button>
                <button type="submit" class="submit-btn save-btn">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<div id="delete-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('delete-modal')">&times;</span>
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this booking?</p>
        <div class="modal-buttons">
            <button type="button" class="cancel-btn">Cancel</button>
            <button type="button" id="confirm-delete-btn" class="confirm-btn">Delete</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('profile-modal')">&times;</span>
        <h3>Update Profile</h3>
        <form id="profile-form">
            <div class="form-group" style="margin: 5px 0; display: flex; gap: 10px;">
                <label for="profile-name">Full Name</label>
                <input style="border-radius: 10px;padding: 8px; background-color: white; color: rgb(5, 5, 5);" type="text" id="profile-name" required>
            </div>
            <div class="form-group">
                <label for="profile-pic">Profile Picture</label>
                <input style=" border-radius: 10px;padding: 8px; background-color: white; color: rgb(5, 5, 5);" type="file" id="profile-pic" accept="image/*">
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" onclick="closeModal('profile-modal')">Cancel</button>
                <br>
                <button type="submit" class="submit-btn save-btn">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<footer style="
    text-align: center;
    padding: 20px;
    background-color: #05011b;
    color: #ffffff;
    font-family: Arial, sans-serif;
    font-size: 14px;
    border-top: 1px solid #ddd;
">
    &copy; 2025 All rights reserved. Zahid Hasan
</footer>

<script>
    // Firebase এবং Firestore ইনিশিয়ালাইজ করুন
const firebaseConfig = {
    apiKey: "AIzaSyA9WlrzwofCXAAEFuDgHCBuChNO_0pCA1M",
    authDomain: "trims-booking.firebaseapp.com",
    projectId: "trims-booking",
    storageBucket: "trims-booking.firebasestorage.app",
    messagingSenderId: "4950810595",
    appId: "1:4950810595:web:ae0dd99a81f7b1c53b8ad6",
    measurementId: "G-ZXWJB2X54Y"
};

const app = firebase.initializeApp(firebaseConfig);
const db = app.firestore();
    
document.addEventListener('DOMContentLoaded', () => {
    const authContainer = document.getElementById('auth-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const dashboardContainer = document.getElementById('dashboard-container');
    const showRegisterBtn = document.getElementById('show-register');
    const showLoginBtn = document.getElementById('show-login');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const editProfileBtn = document.getElementById('edit-profile-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const profileModal = document.getElementById('profile-modal');
    const profileForm = document.getElementById('profile-form');
    const profileNameInput = document.getElementById('profile-name');
    const profilePicInput = document.getElementById('profile-pic');
    const userNameDisplayHeader = document.getElementById('user-name-display-header');
    const profileAvatarHeader = document.getElementById('profile-avatar-header');
    const uploadExcelBtn = document.getElementById('upload-excel-btn');
    const excelFileInput = document.getElementById('excel-file-input');
    const downloadTemplateBtn = document.getElementById('download-template-btn');

    const bookingForm = document.getElementById('booking-form');
    const bookingsTableBody = document.getElementById('bookings-table-body');
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const searchInput = document.getElementById('searchInput');
    const fromDateInput = document.getElementById('from-date');
    const toDateInput = document.getElementById('to-date');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const dateInput = document.getElementById('date');
    const notificationContainer = document.getElementById('notification-container');
    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

    let bookingToDeleteId = null;

    // --- Custom Notification Function ---
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notificationContainer.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            notification.classList.remove('show');
            notification.addEventListener('transitionend', () => {
                notification.remove();
            });
        }, 4000);
    }
    
    // --- Modal Control Functions ---
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
        }
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    document.querySelectorAll('.close, .cancel-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const modal = e.target.closest('.modal');
            if (modal) {
                closeModal(modal.id);
            }
        });
    });

    // Initial app state
    checkAuthStatus();

    // --- AUTHENTICATION FUNCTIONS (Using sessionStorage) ---
    function checkAuthStatus() {
        const loggedInUserId = sessionStorage.getItem('loggedInUserId');
        const loggedInUserEmail = sessionStorage.getItem('loggedInUserEmail');

        if (loggedInUserId && loggedInUserEmail) {
            db.collection("users").doc(loggedInUserId).get().then(doc => {
                if (doc.exists) {
                    const user = doc.data();
                    userNameDisplayHeader.textContent = user.fullName || loggedInUserEmail;
                    const profilePicSrc = user.profilePic || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="%23e2e8f0"><path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/></svg>';
                    profileAvatarHeader.src = profilePicSrc;
                    dashboardContainer.style.display = 'flex';
                    authContainer.style.display = 'none';
                    loadBookings();
                } else {
                    sessionStorage.removeItem('loggedInUserId');
                    sessionStorage.removeItem('loggedInUserEmail');
                    checkAuthStatus();
                }
            }).catch(error => {
                console.error("Error getting user document:", error);
                sessionStorage.removeItem('loggedInUserId');
                sessionStorage.removeItem('loggedInUserEmail');
                checkAuthStatus();
            });
        } else {
            dashboardContainer.style.display = 'none';
            authContainer.style.display = 'flex';
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
        }
    }

    showRegisterBtn.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
    });

    showLoginBtn.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
    });

    registerBtn.addEventListener('click', async () => {
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;

        const usersRef = db.collection("users");
        const q = usersRef.where("email", "==", email);
        const querySnapshot = await q.get();

        if (!querySnapshot.empty) {
            showNotification('Email already exists!', 'error');
            return;
        }

        const newUser = {
            fullName: name,
            email: email,
            password: password,
            profilePic: null,
        };

        db.collection("users").add(newUser)
        .then(() => {
            showNotification('Registration successful! Please log in.', 'success');
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
        })
        .catch(error => {
            console.error("Error adding user:", error);
            showNotification('Registration failed!', 'error');
        });
    });

    loginBtn.addEventListener('click', async () => {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        const usersRef = db.collection("users");
        const q = usersRef.where("email", "==", email);
        const querySnapshot = await q.get();

        if (querySnapshot.empty) {
            showNotification('Incorrect email or password!', 'error');
            return;
        }

        let userFound = false;
        querySnapshot.forEach(doc => {
            const userData = doc.data();
            if (userData.password === password) {
                sessionStorage.setItem('loggedInUserId', doc.id);
                sessionStorage.setItem('loggedInUserEmail', userData.email);
                userFound = true;
                checkAuthStatus();
                showNotification('Logged in successfully!', 'success');
            }
        });

        if (!userFound) {
            showNotification('Incorrect email or password!', 'error');
        }
    });

    editProfileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openModal('profile-modal');
        const loggedInUserId = sessionStorage.getItem('loggedInUserId');
        if (loggedInUserId) {
            db.collection("users").doc(loggedInUserId).get().then(doc => {
                if (doc.exists) {
                    const user = doc.data();
                    profileNameInput.value = user.fullName;
                }
            });
        }
    });

    logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        sessionStorage.removeItem('loggedInUserId');
        sessionStorage.removeItem('loggedInUserEmail');
        checkAuthStatus();
        showNotification('Logged out successfully.', 'success');
    });

    profileForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newName = profileNameInput.value;
        const newPicFile = profilePicInput.files[0];
        const loggedInUserId = sessionStorage.getItem('loggedInUserId');
        const loggedInUserEmail = sessionStorage.getItem('loggedInUserEmail');
        
        if (!loggedInUserId) {
            showNotification("Please log in to edit profile.", 'error');
            return;
        }

        function updateUserData(picBase64 = null) {
            const updateData = {
                fullName: newName,
            };
            if (picBase64 !== null) {
                updateData.profilePic = picBase64;
            }

            db.collection("users").doc(loggedInUserId).update(updateData)
            .then(() => {
                checkAuthStatus();
                closeModal('profile-modal');
                showNotification('Profile updated successfully!', 'success');
            })
            .catch(error => {
                console.error("Error updating profile:", error);
                showNotification('Failed to update profile!', 'error');
            });
        }

        if (newPicFile) {
            const reader = new FileReader();
            reader.onloadend = () => {
                updateUserData(reader.result);
            };
            reader.readAsDataURL(newPicFile);
        } else {
            updateUserData(null);
        }
    });

    // --- BOOKING MANAGEMENT FUNCTIONS (Firebase) ---
    function loadBookings() {
        const loggedInUserEmail = sessionStorage.getItem('loggedInUserEmail');

        if (!loggedInUserEmail) {
            bookingsTableBody.innerHTML = '';
            return;
        }

        const bookingsRef = db.collection("bookings");
        const q = bookingsRef.where("userEmail", "==", loggedInUserEmail).orderBy("createdAt", "desc");
        console.log()
        
        q.onSnapshot((querySnapshot) => {
            const bookings = [];
            querySnapshot.forEach((doc) => {
                bookings.push({ id: doc.id, ...doc.data() });
            });

            const searchTerm = searchInput.value.toLowerCase();
            const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
            const toDate = toDateInput.value ? new Date(toDateInput.value) : null;
            
            const filteredBookings = bookings.filter(booking => {
                const matchesSearch = Object.values(booking).some(value =>
                    String(value).toLowerCase().includes(searchTerm)
                );
                
                const bookingDate = new Date(booking.date);
                const matchesFromDate = fromDate ? bookingDate >= fromDate : true;
                const matchesToDate = toDate ? bookingDate <= toDate : true;

                return matchesSearch && matchesFromDate && matchesToDate;
            });

            bookingsTableBody.innerHTML = '';
            filteredBookings.forEach(booking => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${booking.date}</td>
                    <td>${booking.bookingNo}</td>
                    <td>${booking.customer}</td>
                    <td>${booking.buyer}</td>
                    <td>${booking.item}</td>
                    
                    <td class="action-buttons">
                        <button class="edit-btn" data-id="${booking.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn" data-id="${booking.id}"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                bookingsTableBody.appendChild(row);
            });

            if (searchTerm || fromDate || toDate) {
                showNotification(`${filteredBookings.length} results found.`, 'info');
            }
        });
    }

    bookingForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const loggedInUserEmail = sessionStorage.getItem('loggedInUserEmail');
        if (!loggedInUserEmail) {
            showNotification("Please log in to add a booking.", 'error');
            return;
        }

        const newBooking = {
            date: document.getElementById('date').value,
            bookingNo: document.getElementById('bookingNo').value,
            customer: document.getElementById('customer').value,
            buyer: document.getElementById('buyer').value,
            item: document.getElementById('item').value,
            userEmail: loggedInUserEmail, // এখানে userEmail ব্যবহার করা হয়েছে
            createdAt: new Date().toISOString()
        };

        db.collection("bookings").add(newBooking)
        .then(() => {
            bookingForm.reset();
            dateInput.valueAsDate = new Date();
            showNotification('Booking added successfully!', 'success');
            loadBookings();
        })
        .catch((error) => {
            console.error("Error adding document: ", error);
            showNotification('Failed to add booking!', 'error');
        });
    });

   // ... আপনার কোডের উপরের অংশ ...

// সার্চ ইনপুট এবং ফিল্টার বাটন
searchInput.addEventListener('keypress', (e) => {
    // Check if the Enter key was pressed
    if (e.key === 'Enter') {
        loadBookings();
    }
});

// তারিখের ফিল্টারগুলি আগের মতোই থাকবে
fromDateInput.addEventListener('change', loadBookings);
toDateInput.addEventListener('change', loadBookings);

// ক্লিয়ার ফিল্টার বাটন
clearFiltersBtn.addEventListener('click', () => {
    searchInput.value = '';
    fromDateInput.value = '';
    toDateInput.value = '';
    loadBookings();
});

// ... আপনার কোডের বাকি অংশ ...
    fromDateInput.addEventListener('change', loadBookings);
    toDateInput.addEventListener('change', loadBookings);
    
    clearFiltersBtn.addEventListener('click', () => {
        searchInput.value = '';
        fromDateInput.value = '';
        toDateInput.value = '';
        loadBookings();
    });

    // Excel Upload/Download
    uploadExcelBtn.addEventListener('click', () => {
        excelFileInput.click();
    });
    
    excelFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) {
            showNotification("Please select an Excel file to upload.", 'error');
            return;
        }
        const loggedInUserEmail = sessionStorage.getItem('loggedInUserEmail');
        if (!loggedInUserEmail) {
            showNotification("Please log in to upload data.", 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                const headers = json[0];
                const requiredHeaders = ["Date", "Booking No.", "Customer", "Buyer", "Item"];

                if (JSON.stringify(headers) !== JSON.stringify(requiredHeaders)) {
                    showNotification("Incorrect Excel file format. Please use the required format.", 'error');
                    return;
                }
                
                const bookingsCollection = db.collection("bookings");
                const batch = db.batch();
                let uploadCount = 0;

                json.slice(1).forEach(row => {
                    if (row.length === 5) {
                        const newBookingRef = bookingsCollection.doc();
                        batch.set(newBookingRef, {
                            date: row[0],
                            bookingNo: row[1],
                            customer: row[2],
                            buyer: row[3],
                            item: row[4],
                            userEmail: loggedInUserEmail, // এখানে userEmail ব্যবহার করা হয়েছে
                            createdAt: new Date().toISOString()
                        });
                        uploadCount++;
                    }
                });
                
                if (uploadCount > 0) {
                    batch.commit().then(() => {
                        excelFileInput.value = '';
                        showNotification("Bookings from Excel uploaded successfully!", 'success');
                        loadBookings();
                    }).catch(error => {
                        console.error("Error uploading batch:", error);
                        showNotification("Failed to upload all data from Excel.", 'error');
                    });
                } else {
                    showNotification("No valid data found in the Excel file.", 'info');
                }

            } catch (err) {
                showNotification("Failed to process Excel file. Please check the file format.", 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    });
    
    downloadTemplateBtn.addEventListener('click', () => {
        const ws = XLSX.utils.aoa_to_sheet([["Date", "Booking No.", "Customer", "Buyer", "Item"]]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Bookings");
        XLSX.writeFile(wb, "Booking_Template.xlsx");
        showNotification("Excel template downloaded!", 'success');
    });

    // বুকিং এডিট/ডিলিট করার ফাংশন
    bookingsTableBody.addEventListener('click', async (e) => {
        const loggedInUserEmail = sessionStorage.getItem('loggedInUserEmail');
        if (!loggedInUserEmail) {
            showNotification("Please log in to manage bookings.", 'error');
            return;
        }

        if (e.target.closest('.edit-btn')) {
            const id = e.target.closest('.edit-btn').dataset.id;
            const doc = await db.collection("bookings").doc(id).get();
            if (doc.exists && doc.data().userEmail === loggedInUserEmail) {
                const bookingToEdit = doc.data();
                document.getElementById('edit-booking-id').value = id;
                document.getElementById('edit-date').value = bookingToEdit.date;
                document.getElementById('edit-bookingNo').value = bookingToEdit.bookingNo;
                document.getElementById('edit-customer').value = bookingToEdit.customer;
                document.getElementById('edit-buyer').value = bookingToEdit.buyer;
                document.getElementById('edit-item').value = bookingToEdit.item;
                openModal('edit-modal');
            } else {
                showNotification("Booking not found or you don't have permission to edit!", 'error');
            }
        } else if (e.target.closest('.delete-btn')) {
            const id = e.target.closest('.delete-btn').dataset.id;
            const doc = await db.collection("bookings").doc(id).get();
            if (doc.exists && doc.data().userEmail === loggedInUserEmail) {
                bookingToDeleteId = id;
                openModal('delete-modal');
            } else {
                showNotification("Booking not found or you don't have permission to delete!", 'error');
            }
        }
    });
    
    // ডিলিট কনফার্ম করার ফাংশন
    confirmDeleteBtn.addEventListener('click', () => {
        const loggedInUserEmail = sessionStorage.getItem('loggedInUserEmail');
        if (!loggedInUserEmail || !bookingToDeleteId) {
            showNotification("Error: Not logged in or no booking selected.", 'error');
            return;
        }
        db.collection("bookings").doc(bookingToDeleteId).delete().then(() => {
            closeModal('delete-modal');
            showNotification('Booking deleted successfully!', 'success');
            bookingToDeleteId = null;
            loadBookings();
        }).catch((error) => {
            console.error("Error removing document: ", error);
            showNotification('Error deleting booking!', 'error');
        });
    });

    // বুকিং সেভ করার ফাংশন
    editForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-booking-id').value;
        const loggedInUserEmail = sessionStorage.getItem('loggedInUserEmail');
        if (!loggedInUserEmail) {
            showNotification("Please log in to update a booking.", 'error');
            return;
        }
        
        const updatedBooking = {
            date: document.getElementById('edit-date').value,
            bookingNo: document.getElementById('edit-bookingNo').value,
            customer: document.getElementById('edit-customer').value,
            buyer: document.getElementById('edit-buyer').value,
            item: document.getElementById('edit-item').value
        };
        
        db.collection("bookings").doc(id).get().then(doc => {
            if (doc.exists && doc.data().userEmail === loggedInUserEmail) {
                db.collection("bookings").doc(id).update(updatedBooking).then(() => {
                    closeModal('edit-modal');
                    showNotification('Booking updated successfully!', 'success');
                    loadBookings();
                }).catch((error) => {
                    console.error("Error updating document: ", error);
                    showNotification('Error updating booking!', 'error');
                });
            } else {
                showNotification("You don't have permission to update this booking!", 'error');
                closeModal('edit-modal');
            }
        });
    });

    dateInput.valueAsDate = new Date();
});
</script>

</body>
</html>